<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - 팀 보드</title>
    <link rel="stylesheet" href="css/TeamSetting.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- 해담바 -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">해시보드</li>
                <li class="sidebar-link" data-link="TeamPage.html">팀 페이지</li>
                <li class="sidebar-link" data-link="GanttChart.html">간트 차트</li>
                <li class="sidebar-link" data-link="IssuePage.html">이슈</li>
                <li class="sidebar-link" data-link="TeamBoard.html">팀 보드</li>
                <li class="sidebar-link active" data-link="TeamSetting.html">팀 세팅</li>
            </ul>
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="contentGrid">
            <div class="card">
		    	<h2>프로젝트 명: <span id="projectName">쌈@빵한 프로젝트 이름</span></h2>
			    <p><strong>책임자:</strong> <span id="projectOwner">책임자이름 (책임자 이메일)</span></p>
			    <p><strong>프로젝트 설명:</strong> <span id="projectDescription">쌈빵한 프로젝트 설명 12356788887654324098490544182358 ^ 235</span></p>
			    <button class="danger-btn">프로젝트 폐기</button>
			</div>

	        <div class="card team-container">
	            <h3>팀원 관리</h3>
	            <button onclick="addTeamMember()">팀원 추가</button>
	            <div class="team-list" id="team-list">
	                <div class="team-member">
	                    <span>김재욱 (dummy@molepres.com)</span>
	                    <button class="remove-btn" onclick="removeMember(this)">제거</button>
	                </div>
	            </div>
        	</div>
        </div>
    </div>

    <!-- 프로필 메뉴 -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">홈</li>
                <li data-link="TeamPage.html">팀 페이지</li>
                <li data-link="FindTeam.html">팀 찾기</li>
                <li data-link="CreateTeam.html">팀 만들기</li>
                <li data-link="TeamManage.html">팀 관리</li>
                <li data-link="ProfilePage.html">프로필</li>
                <li data-link="SettingsPage.html">설정</li>
            </ul>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let userId, projectId;

        // 1. 세션에서 userId 가져오기
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("로그인하지 않았습니다.")) {
                    alert("로그인이 필요합니다.");
                    window.location.href = "index.html";  // 로그인 페이지로 이동
                } else {
                    userId = response.trim();
                    console.log("User ID:", userId);  // 디버깅용 출력
                    loadProjectDetails(userId);  // 프로젝트 정보 불러오기
                }
            },
            error: function() {
                alert("사용자 정보를 불러오는 데 실패했습니다.");
            }
        });

        // 2. 세션에서 projectId 가져오기
        $.ajax({
            url: "jsp/projectsession.jsp",
            type: "GET",
            success: function(response) {
                projectId = response.trim();
                if (!projectId || projectId === "error") {
                    alert("프로젝트를 다시 선택하세요.");
                    window.location.href = "MainPage.html";  // 메인 페이지로 이동
                } else {
                    console.log("Project ID:", projectId);  // 디버깅용 출력
                    loadProjectDetails(userId, projectId);  // 프로젝트 정보 불러오기
                }
            },
            error: function() {
                alert("프로젝트 ID를 불러오는 데 실패했습니다.");
            }
        });

        // 3. 프로젝트 정보 불러오기
        function loadProjectDetails(userId, projectId) {
            if (!userId || !projectId) return;
            $.ajax({
                url: "jsp/GetProjectDetails.jsp",
                type: "GET",
                data: { userId: userId, projectId: projectId },
                dataType: "json",
                success: function(data) {
                    console.log("프로젝트 데이터:", data);  // 디버깅: 반환된 데이터 확인

                    if (data.status === "fail") {
                        alert("에러: " + data.message);
                    } else {
                        $("#projectName").text(data.projectName || "프로젝트 이름 없음");
                        $("#projectOwner").text(`${data.ownerName} (${data.ownerEmail})` || "책임자 정보 없음");
                        $("#projectDescription").text(data.description || "프로젝트 설명 없음");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("AJAX 오류:", status, error);
                    alert("프로젝트 정보를 불러오는 데 실패했습니다. 오류: " + error);
                }
            });


        }
    });

        // 사이드바 클릭 이벤트
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', function () {
                const targetPage = this.getAttribute('data-link');
                window.location.href = targetPage;
            });
        });

        // 프로필 메뉴 클릭
        const profileBtn = document.getElementById("profileBtn");
        const profileMenu = document.getElementById("profileMenu");

        profileBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            profileMenu.classList.toggle("active");
        });

        document.addEventListener("click", function (event) {
            if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.remove("active");
            }
        });

        // 프로필 메뉴 클릭 시 페이지 이동
        document.querySelectorAll('.profile-menu li').forEach(item => {
            item.addEventListener('click', function () {
                const targetPage = this.getAttribute('data-link');
                window.location.href = targetPage;
            });
        });

        function addTeamMember() {
            const userID = prompt("초대할 팀원의 이메일을 입력하세요:");
			$.ajax({
				type:"POST",
				url: "jsp/UserInvite.jsp",
				data: {
					userID: userID
				},
				success: function (response) {
                    console.log("UserInvite.jsp 응답:", response);
                },
                error: function (xhr, status, error) {
                    console.error("팀원 초대 AJAX 오류:", status, error);
                }
				
				
			});
        }
        function removeMember(button) {
            button.parentElement.remove();
        }
    </script>
</body>
</html>
