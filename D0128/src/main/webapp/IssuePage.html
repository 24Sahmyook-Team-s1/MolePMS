<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - 이슈 관리</title>
    <link rel="stylesheet" href="css/IssuePage.css">
</head>
<body>

    <!-- 상단바 -->
    <div class="header">
        <h2>MOLE</h2>
    </div>

    <div class="container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">대시보드</li>
                <li class="sidebar-link" data-link="TeamPage.html">팀 페이지</li>
                <li class="sidebar-link" data-link="GanttChart.html">간트 차트</li>
                <li class="sidebar-link" data-link="IssuePage.html">이슈</li>
                <li class="sidebar-link" data-link="TeamBoard.html">팀 보드</li>
            </ul>
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <h1>
                <span>위험 관리</span>
                <div class="issue-buttons">
                    <button class="add-btn">이슈 추가</button>
                    <button class="delete-btn">이슈 삭제</button>
                    <button class="update-btn">이슈 업데이트</button>
                </div>
            </h1>

            <div class="issue-container">
                <!-- HAZARD -->
                <div class="issue-column hazard">
                    <h2>HAZARD ⚠️</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="hazardList"></div>
                </div>

                <!-- ISSUE -->
                <div class="issue-column issue">
                    <h2>ISSUE ⚠️</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="issueList"></div>
                </div>

                <!-- SOLVED -->
                <div class="issue-column solved">
                    <h2>SOLVED 🟢</h2>
                    <div class="issue-header">
                        <span>Name</span>
                        <span>Issue Description</span>
                    </div>
                    <div class="issue-list" id="solvedList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 프로필 메뉴 -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">홈</li>
                <li data-link="TeamPage.html">팀 페이지</li>
                <li data-link="FindTeam.html">팀 찾기</li>
                <li data-link="CreateTeam.html">팀 만들기</li>
                <li data-link="TeamManage.html">팀 관리</li>
                <li data-link="ProfilePage.html">프로필</li>
                <li data-link="SettingsPage.html">설정</li>
            </ul>
        </div>
    </div>

    <!-- 이슈 추가 모달 -->
    <div class="modal" id="addIssueModal">
        <div class="modal-content">
            <h2>이슈 추가</h2>
            <form id="addIssueForm">
                <label for="addUser">작성자 코드</label>
                <input type="text" id="addUser" name="projectuserid" required>
                <label for="addProjectId">프로젝트 코드</label>
                <input type="text" id="addProjectId" name="projectid" required>
                <label for="addCategory">카테고리</label>
                <select id="addCategory" name="category" required>
                    <option value="HAZARD">HAZARD</option>
                    <option value="ISSUE">ISSUE</option>
                    <option value="SOLVED">SOLVED</option>
                </select>
                <label for="addTitle">제목</label>
                <input type="text" id="addTitle" name="title" required>
                <label for="addDescription">본문</label>
                <input type="text" id="addDescription" name="description" required>
                <button type="submit" class="add-btn">추가</button>
                <button type="button" class="close">닫기</button>
            </form>
        </div>
    </div>

    <!-- 이슈 삭제 모달 -->
    <div class="modal" id="deleteIssueModal">
        <div class="modal-content">
            <h2>이슈 삭제</h2>
            <form id="deleteIssueForm">
                <label for="deleteId">이슈 ID</label>
                <input type="text" id="deleteId" name="projectissueid" required>
                <button type="submit" class="delete-btn">삭제</button>
                <button type="button" class="close">닫기</button>
            </form>
        </div>
    </div>

    <!-- 이슈 업데이트 모달 -->
    <div class="modal" id="updateIssueModal">
        <div class="modal-content">
            <h2>이슈 업데이트</h2>
            <form id="updateIssueForm">
                <label for="updateId">이슈 ID</label>
                <input type="text" id="updateId" name="projectissueid" required>
                <label for="updateTitle">제목</label>
                <input type="text" id="updateTitle" name="title" required>
                <label for="updateDescription">본문</label>
                <input type="text" id="updateDescription" name="description" required>
                <button type="submit" class="update-btn">업데이트</button>
                <button type="button" class="close">닫기</button>
            </form>
        </div>
    </div>

    <script>
    // 📌 프로필 버튼 클릭 시 메뉴 표시
    const profileBtn = document.getElementById("profileBtn");
    const profileMenu = document.getElementById("profileMenu");

    profileBtn.addEventListener("click", function (event) {
        event.stopPropagation();
        profileMenu.classList.toggle("active");
    });

    document.addEventListener("click", function (event) {
        if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
            profileMenu.classList.remove("active");
        }
    });

    // 📌 프로필 메뉴 클릭 시 페이지 이동
    document.querySelectorAll('.profile-menu li').forEach(item => {
        item.addEventListener('click', function () {
            const targetPage = this.getAttribute('data-link');
            window.location.href = targetPage;
        });
    });

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelector('.add-btn').addEventListener('click', () => openModal('addIssueModal'));
            document.querySelector('.delete-btn').addEventListener('click', () => openModal('deleteIssueModal'));
            document.querySelector('.update-btn').addEventListener('click', () => openModal('updateIssueModal'));

            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', () => closeModal(closeBtn.closest('.modal')));
            });

            window.addEventListener('click', function (event) {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target);
                }
            });

            document.getElementById('addIssueForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitForm('jsp/projectIssueAdd.jsp', new FormData(this));
            });

            document.getElementById('deleteIssueForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitForm('jsp/projectIssueDelete.jsp', new FormData(this));
            });

            document.getElementById('updateIssueForm').addEventListener('submit', function (e) {
                e.preventDefault();
                submitForm('jsp/projectIssueUpdate.jsp', new FormData(this));
            });
        });

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
        }

        function submitForm(url, formData) {
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                alert('작업이 성공적으로 완료되었습니다.');
                closeModal(document.querySelector('.modal[style*="block"]'));
                fetchIssues();
            })
            .catch(error => {
                console.error('에러 발생:', error);
                alert('작업 중 오류가 발생했습니다.');
            });
        }
        document.getElementById('addIssueForm').addEventListener('submit', function (e) {
            e.preventDefault(); // 기본 폼 제출 방지

            const formData = new FormData(this);

            // 디버깅용: 전송되는 데이터 콘솔 출력
            console.log("Sending Data:");
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }

            fetch('jsp/projectIssueAdd.jsp', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                alert('이슈가 성공적으로 추가되었습니다.');
                closeModal(document.getElementById('addIssueModal'));
            })
            .catch(error => {
                console.error('에러 발생:', error);
            });
        });

    </script>
</body>
</html>
