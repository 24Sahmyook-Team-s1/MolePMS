<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <title>MOLE - Gantt Chart</title>
    <link rel="stylesheet" href="./css/GanttChart.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>

    <!-- 📌 상단바 -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- 📌 왼쪽 사이드바 -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">대시보드</li>
                <li class="sidebar-link" data-link="TeamPage.html">팀 페이지</li>
                <li class="sidebar-link" data-link="GanttChart.html">간트 차트</li>
                <li class="sidebar-link" data-link="IssuePage.html">이슈</li>
                <li class="sidebar-link" data-link="TeamBoard.html">팀 보드</li>
                <li class="sidebar-link active" data-link="TeamSetting.html">팀 세팅</li>
            </ul>
        </div>

        <!-- 📌 메인 컨텐츠 (간트차트) -->
        <div class="main-content">
            <h2>Gantt Chart</h2>
            <div id="ganttChart" style="width:100%; height:700px"></div>
        </div>
    </div>

    <!-- 📌 프로필 메뉴 (오른쪽 하단 위치) -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
				<li data-link="MainPage.html">홈</li>
                <li data-link="TeamPage.html">팀 페이지</li> <!-- ✅ 팀 페이지 추가 -->
                <li data-link="FindTeam.html">팀 찾기</li>
                <li data-link="CreateTeam.html">팀 만들기</li>
                <li data-link="TeamManage.html">팀 관리</li>
                <li data-link="ProfilePage.html">프로필</li>
                <li data-link="SettingsPage.html">설정</li> </ul>
        </div>
    </div>
    
	<script>
	let projectId;
    let userId;
	
	window.addEventListener("DOMContentLoaded", function () {
		gantt.init("ganttChart");

        // 간트 차트 설정
        gantt.config.columns = [
            { name: "text", label: "Task name", width: "*", tree: true },
            { name: "start_date", label: "Start date", align: "center", width: 100 },
            { name: "duration", label: "Duration", align: "center", width: 70 },
            { name: "progress", label: "Progress", align: "center", width: 70 }
        ];

        gantt.config.scale_unit = "week";
        gantt.config.date_scale = "%F %Y";
        gantt.config.subscales = [
            { unit: "day", step: 1, date: "%j, %D" }
        ];

        gantt.config.fit_tasks = true;
        gantt.config.autofit = true;
    });
		
    $(document).ready(function () {
        
        $.ajax({
            url: "jsp/session.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("로그인하지 않았습니다.")) {
                    alert("로그인이 필요합니다.");
                    window.location.href = "index.html"; // 로그인 페이지로 이동
                }
                else{
                	userId = response.trim(); // 세션에서 사용자 ID를 가져오는 부분
                	console.log("유저 id: " + userId);
                	$.ajax({
                        url: "jsp/projectsession.jsp",
                        type: "GET",
                        success: function(response) {
                            if (response.includes("error")) {
                                alert("프로젝트를 다시골라 주세요.");
                                window.location.href = "MainPage.html"; // 메인 페이지로 이동
                            }
                            else{
                            	projectId = response.trim(); // 세션에서 사용자 ID를 가져오는 부분
                                console.log("프로젝트 id: " + projectId);
                                loadGanttChart();
                                console.log("페이지 로드 + 유저 id, 프로젝트 id 완료");
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error("세션 확인 중 오류 발생:", error);
                        }
                    });
                    console.log("페이지 로드 + 유저 id, 프로젝트 id 완료");
                }
            },
            error: function(xhr, status, error) {
                console.error("세션 확인 중 오류 발생:", error);
            }
        });
        // 📌 사이드바 및 프로필 메뉴 클릭 시 페이지 이동
        $(".sidebar-link, .profile-menu li").on("click", function () {
            const targetPage = $(this).data("link");
            window.location.href = targetPage;
        });

        // 📌 프로필 버튼 클릭 시 메뉴 토글
        const profileBtn = $("#profileBtn");
        const profileMenu = $("#profileMenu");

        profileBtn.on("click", function (event) {
            event.stopPropagation();
            profileMenu.toggleClass("active");
        });

        $(document).on("click", function (event) {
            if (!profileBtn.is(event.target) && !profileMenu.is(event.target) && profileMenu.has(event.target).length === 0) {
                profileMenu.removeClass("active");
            }
        });

        function loadGanttChart() {
            console.log("projectId: "+projectId);
            
            // 프로젝트 기본 정보 먼저 가져오기
            $.ajax({
                url: "jsp/GetProject.jsp",
                type: "POST",
                data: {projectId},
                dataType: "json",
                success: function (projectData) {
                    console.log("✅ 프로젝트 데이터 수신:", projectData);
                    
                    // 해당 프로젝트의 할일 목록 가져오기
                    $.ajax({
                        url: "jsp/GetTasks.jsp",
                        type: "POST",
                        data: {projectId},
                        dataType: "json",
                        success: function (tasksData) {
                            console.log("✅ 할일 데이터 수신:", tasksData);
                            
                            // 데이터 구조 변환
                            const ganttData = [{
                                id: projectData.id,
                                text: projectData.name,
                                start_date: convertDate(projectData.created_at),
                                duration: calculateDuration(
                                    projectData.created_at, 
                                    tasksData.reduce((maxDate, task) => {
                                        return new Date(task.endDate) > new Date(maxDate) ? task.endDate : maxDate;
                                    }, projectData.created_at)
                                ),
                                progress: 0.4, // 프로젝트 진행률 (예시 값)
                                open: true
                            }];

                            // 할일 데이터 추가
                            tasksData.forEach((task, index) => {
                            	let progress=0;
                            	if (task.status === "todo") {
                            	    progress = 0; // 시작하지 않음
                            	} else if (task.status === "inProgress") {
                            	    progress = 0.5; // 진행 중
                            	} else if (task.status === "completed") {
                            	    progress = 1; // 완료
                            	} else {
                            	    progress = 0; // 알 수 없는 상태
                            	}
                                ganttData.push({
                                    id: task.scheduleId,
                                    text: task.taskName,
                                    start_date: convertDate(task.startDate),
                                    duration: calculateDuration(task.startDate, task.endDate),
                                    progress: progress, // 상태에 따른 진행률
                                    parent: projectData.id
                                });
                            });

                            // 간트 차트 렌더링
                            renderGanttChart(ganttData);
                        },
                        error: function (xhr, status, error) {
                            console.error("❌ 할일 데이터 로드 오류:", error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("❌ 프로젝트 데이터 로드 오류:", error);
                }
            });
        }

        // 날짜 변환 함수 (yyyy-mm-dd → dd-mm-yyyy)
        function convertDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }

        // 기간 계산 함수
        function calculateDuration(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diff = end - start;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        // 간트 차트 렌더링 함수
        function renderGanttChart(data) {
            gantt.init("ganttChart");
            
            // 간트 차트 설정
            gantt.config.columns = [
                {name: "text", label: "Task name", width: "*", tree: true },
                {name: "start_date", label: "Start", align: "center", width: 100 },
                {name: "duration", label: "Duration", align: "center", width: 80 },
                {name: "progress", label: "Progress", align: "center", width: 80 }
            ];
            
            gantt.config.scale_unit = "day";
            gantt.config.date_scale = "%d %M";
            gantt.config.subscales = [
                {unit: "week", step: 1, date: "Week #%W"}
            ];
            
            gantt.templates.task_class = function(start, end, task) {
                return task.parent ? "child-task" : "parent-project";
            };
            
            gantt.parse({ data });
        }
            });

            // 📌 프로젝트 클릭 시 모달 열기
            $(".gantt-row").on("click", function () {
                const projectId = $(this).data("id");
                $("#projectId").val(projectId);
                $("#scheduleModal").show();
            });
    </script>

</body>
</html>