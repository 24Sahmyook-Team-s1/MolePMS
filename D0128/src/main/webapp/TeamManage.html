<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팀 관리</title>
    <link rel="stylesheet" href="css/TeamPage.css">
</head>
<body>

    <div class="header">
        <h1>MOLE - 팀 관리</h1>
    </div>

    <div class="container">
        <h2>참여 요청 목록</h2>
        <div class="request-list" id="requestList">
            <!-- 요청 목록이 여기에 표시됨 -->
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        function fetchRequests() {
            fetch("jsp/GetJoinRequests.jsp")
                .then(response => response.json())
                .then(requests => {
                    const requestList = document.getElementById("requestList");
                    requestList.innerHTML = "";

                    requests.forEach(request => {
                        let div = document.createElement("div");
                        div.classList.add("request-card");
                        div.innerHTML = `
                            <strong>${request.userId}</strong> 님이 팀에 참여 요청을 보냈습니다. <br>
                            <button class="approve-btn" 
                                    data-request-id="${request.requestId}" 
                                    data-user-id="${request.userId}" 
                                    data-team-id="${request.teamId}">✔ 수락</button>
                            <button class="reject-btn" data-request-id="${request.requestId}">❌ 거절</button>
                        `;
                        requestList.appendChild(div);
                    });

                    // ✅ 승인 버튼 이벤트 추가
                    document.querySelectorAll(".approve-btn").forEach(button => {
                        button.addEventListener("click", function () {
                            const requestId = this.dataset.requestId;
                            const userId = this.dataset.userId;
                            const teamId = this.dataset.teamId;

                            console.log(`승인 요청: requestId=${requestId}, userId=${userId}, teamId=${teamId}`);

                            if (!requestId || !userId || !teamId) {
                                alert("잘못된 요청: requestId, userId 또는 teamId가 없습니다.");
                                return;
                            }

                            fetch("jsp/ApproveJoinRequest.jsp", {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                body: `requestId=${requestId}&userId=${userId}&teamId=${teamId}`
                            })
                            .then(response => response.json())
                            .then(data => {
                                alert(data.message);
                                fetchRequests();
                            })
                            .catch(error => console.error("팀 참여 승인 실패:", error));
                        });
                    });

                    // ❌ 거절 버튼 이벤트 추가
                    document.querySelectorAll(".reject-btn").forEach(button => {
                        button.addEventListener("click", function () {
                            const requestId = this.dataset.requestId;

                            if (!requestId) {
                                alert("잘못된 요청: requestId가 없습니다.");
                                return;
                            }

                            fetch("jsp/RejectJoinRequest.jsp", {
                                method: "POST",
                                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                                body: `requestId=${requestId}`
                            })
                            .then(response => response.json())
                            .then(data => {
                                alert(data.message);
                                fetchRequests();
                            })
                            .catch(error => console.error("팀 참여 거절 실패:", error));
                        });
                    });
                })
                .catch(error => console.error("참여 요청 목록 불러오기 실패:", error));
        }

        fetchRequests();
    });
    function approveRequest(requestId, userId, teamId) {
        console.log(`✅ 승인 요청 보내기: requestId=${requestId}, userId=${userId}, teamId=${teamId}`);

        fetch("jsp/ApproveJoinRequest.jsp", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `requestId=${requestId}&userId=${userId}&teamId=${teamId}`
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            location.reload();  // 새로고침하여 반영
        })
        .catch(error => console.error("팀 승인 요청 실패:", error));
    }

  </script>

</body>
</html>
