<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - 팀 보드</title>
    <link rel="stylesheet" href="css/TeamBoard.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- 해담바 -->
    <div class="header">
        <h1>MOLE</h1>
    </div>

    <div class="container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <ul>
                <li class="sidebar-link" data-link="MainPage.html">해시보드</li>
                <li class="sidebar-link" data-link="TeamPage.html">팀 페이지</li>
                <li class="sidebar-link" data-link="GanttChart.html">간트 채트</li>
                <li class="sidebar-link" data-link="IssuePage.html">이슈</li>
                <li class="sidebar-link active" data-link="TeamBoard.html">팀 보드</li>
                <li class="sidebar-link active" data-link="TeamSetting.html">팀 세팅</li>
            </ul>
        </div>

        <!-- 메인 컨텐츠 -->
        <div class="main-content">
            <h2>팀 보드</h2>
            <div class="team-doc-container" id="teamDocContainer">
                <!-- JavaScript로 동적으로 추가될 것입니다. -->
            </div>
        </div>
    </div>

    <!-- 프로필 메뉴 -->
    <div class="profile-container">
        <img src="public/logo-transparent.png" alt="MOLE PMS Logo" class="profile-btn" id="profileBtn">
        <div class="profile-menu" id="profileMenu">
            <ul>
                <li data-link="MainPage.html">홈</li>
                <li data-link="TeamPage.html">팀 페이지</li>
                <li data-link="FindTeam.html">팀 찾기</li>
                <li data-link="CreateTeam.html">팀 만들기</li>
                <li data-link="TeamManage.html">팀 관리</li>
                <li data-link="ProfilePage.html">프로필</li>
                <li data-link="SettingsPage.html">설정</li>
            </ul>
        </div>
    </div>

    <script>
        // 사이드바 클릭 이벤트
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', function () {
                const targetPage = this.getAttribute('data-link');
                window.location.href = targetPage;
            });
        });

        // 프로필 메뉴 클릭
        const profileBtn = document.getElementById("profileBtn");
        const profileMenu = document.getElementById("profileMenu");

        profileBtn.addEventListener("click", function (event) {
            event.stopPropagation();
            profileMenu.classList.toggle("active");
        });

        document.addEventListener("click", function (event) {
            if (!profileBtn.contains(event.target) && !profileMenu.contains(event.target)) {
                profileMenu.classList.remove("active");
            }
        });

        // 프로필 메뉴 클릭 시 페이지 이동
        document.querySelectorAll('.profile-menu li').forEach(item => {
            item.addEventListener('click', function () {
                const targetPage = this.getAttribute('data-link');
                window.location.href = targetPage;
            });
        });
        
        let projectId;
        let userId;

        // 팀 보드 프로젝트 조회 및 표시
        $(document).ready(function () {
            
            $.ajax({
                url: "jsp/session.jsp",
                type: "GET",
                success: function(response) {
                    if (response.includes("로그인하지 않았습니다.")) {
                        alert("로그인이 필요합니다.");
                        window.location.href = "index.html"; // 로그인 페이지로 이동
                    }
                    else{
                    	userId = response; // 세션에서 사용자 ID를 가져오는 부분
                    	console.log("유저 id: " + userId);
                    	$.ajax({
                            url: "jsp/projectsession.jsp",
                            type: "GET",
                            success: function(response) {
                                if (response.includes("error")) {
                                    alert("프로젝트를 다시골라 주세요.");
                                    window.location.href = "MainPage.html"; // 메인 페이지로 이동
                                }
                                else{
                                	projectId = response; // 세션에서 사용자 ID를 가져오는 부분
                                    console.log("프로젝트 id: " + projectId);
                                    loadTeamDocs();
                                    console.log("페이지 로드 + 유저 id, 프로젝트 id 완료");
                                }
                            },
                            error: function(xhr, status, error) {
                                console.error("세션 확인 중 오류 발생:", error);
                            }
                        });
                        console.log("페이지 로드 + 유저 id, 프로젝트 id 완료");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("세션 확인 중 오류 발생:", error);
                }
            });
            
            

            function loadTeamDocs() {
                $.ajax({
                    url: "jsp/GetProjectList.jsp",
                    type: "GET",
                    dataType: "json",
                    success: function (projects) {
                        console.log("프로젝트 데이터 수신:", projects);
                        displayTeamDocs(projects);
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX 오류 발생:", error);
                    },
                });
            }

            function displayTeamDocs(projects) {
                let container = $("#teamDocContainer");
                container.empty();

                if (projects.length > 0) {
                    projects.forEach(project => {
                        container.append(getTeamDocHTML(project));
                    });
                } else {
                    container.append("<p>현재 표시할 팀 문서가 없습니다.</p>");
                }
            }

            function getTeamDocHTML(project) {
                return `
                    <div class="team-doc">
                        <img src="public/doc-icon.png" alt="Team Doc Icon">
                        <h3>${project.name}</h3>
                        <p>Created: ${project.created_at}</p>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
