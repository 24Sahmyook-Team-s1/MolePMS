<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOLE - 팀 게시판</title>
    <link rel="stylesheet" href="css/TeamBoard.css">
    <script src="js/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="header"><h1>MOLE</h1></div>
    <div class="container">
        <div class="sidebar">
            <ul>
                <li data-link="MainPage.html">대시보드</li>
                <li data-link="TeamPage.html">팀 페이지</li>
                <li data-link="GanttChart.html">간트 차트</li>
                <li data-link="IssuePage.html">이슈</li>
                <li data-link="TeamBoard.html" class="active">팀 보드</li>
                <li data-link="TeamSetting.html">팀 세팅</li>
            </ul>
        </div>
        <div class="main-content">
            <h2>팀 게시판</h2>
            <button id="openModalBtn" class="open-modal-btn">글 작성</button>
            <div id="postsContainer"></div>
        </div>
    </div>

    <!-- 글 작성 모달 -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <h3>새 글 작성</h3>
            <input type="text" id="postTitle" placeholder="제목을 입력하세요">
            <textarea id="postContent" placeholder="내용을 입력하세요"></textarea>
            <input type="file" id="postFile">
            <button id="submitPostBtn">작성 완료</button>
            <button id="closeModalBtn" class="close-btn">닫기</button>
        </div>
    </div>

    <script>
    let projectId;

    $(document).ready(function () {
        // 프로젝트 세션 가져오기
        $.ajax({
            url: "jsp/projectsession.jsp",
            type: "GET",
            success: function(response) {
                if (response.includes("error")) {
                    alert("프로젝트를 다시 선택하세요.");
                    window.location.href = "MainPage.html";
                } else {
                    projectId = response.trim();
                    loadPosts();
                }
            },
            error: function(xhr, status, error) {
                console.error("프로젝트 세션 오류:", error);
            }
        });

        // 모달 열기/닫기
        $("#openModalBtn").click(() => $("#postModal").show());
        $("#closeModalBtn").click(() => $("#postModal").hide());

        // 글 작성 이벤트
        $("#submitPostBtn").click(function () {
            const title = $("#postTitle").val().trim();
            const content = $("#postContent").val().trim();
            const file = $("#postFile")[0].files[0];
            const formData = new FormData();

            if (!title || !content) {
                alert("제목과 내용을 입력하세요.");
                return;
            }

            formData.append("projectId", projectId);
            formData.append("title", title);
            formData.append("content", content);
            if (file) formData.append("file", file);

            $.ajax({
                url: "jsp/CreatePost.jsp",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === "success") {
                        alert("글 작성 성공!");
                        loadPosts();
                        $("#postModal").hide();
                    } else {
                        alert("글 작성 실패: " + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("글 작성 오류:", error);
                }
            });
        });

        // 게시글 불러오기
        function loadPosts() {
            $.ajax({
                url: "jsp/GetPosts.jsp",
                type: "GET",
                data: { projectId: projectId },
                dataType: "json",
                success: function(posts) {
                    $("#postsContainer").empty();
                    if (posts.length > 0) {
                        posts.forEach(post => {
                            $("#postsContainer").append(`
                                <div class="post">
                                    <h3>${post.title || "제목 없음"}</h3>
                                    <p>${post.content || "내용 없음"}</p>
                                    <small>작성일: ${post.createdAt}</small>
                                </div>
                            `);
                        });
                    } else {
                        $("#postsContainer").append("<p>게시글이 없습니다.</p>");
                    }
                },
                error: function(xhr, status, error) {
                    console.error("게시글 불러오기 실패:", error);
                }
            });
        }

        // 사이드바 클릭 이벤트
        $(".sidebar li").on("click", function () {
            const link = $(this).data("link");
            if (link) window.location.href = link;
        });
    });
    </script>
</body>
</html>
